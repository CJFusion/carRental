<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Available Cars</title>
	<link rel="stylesheet" type="text/css" href="../assets/app.css">
	<script type="text/javascript" src="https://maraks-car-rental.000webhostapp.com/assets/app.js"></script>
</head>

<body class="greyBg" onload="loadProfileOverlay()">
	<nav class="navBar flexCentered">
		<div class="flexItem">
			<h2>Rent a Car</h2>
		</div>
		<div class="flexItem occupyMin">
			<div id="rentPage_userIcon" role="button" class="userIcon"></div>
			<div id="profileOverlay" class="profileOverlay">

				<div class="profileOverlayContent">
					<h3>...</h3>
					<span class="flexCentereds">
						<button class="registerBtn agencyBtns" onclick="profileOpts('addCar.html')">Add Cars</button>
						<button class="registerBtn agencyBtns" onclick="profileOpts('viewRentals.html')">View
							Rentals</button>
						<button class="registerBtn" onclick="logout()">Logout</button>
					</span>
				</div>

			</div>
		</div>
	</nav>

	<div id="carList" class="grid margin">
		<!-- Car details will be displayed here -->
		<div id="loader"></div>
	</div>



	<style>
		.margin {
			margin: 16px;
		}

		.grid {
			display: grid;
			justify-items: center;
			grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
			/* grid-template-rows: repeat(5, 500px); */
			gap: 20px;
		}

		.gridItem {
			display: grid;
			grid-template-rows: repeat(5, minmax(2rem, 3rem));
			width: 265px;
			height: 210px;
			border: 1px solid;
			padding: 8px;
			margin: 8px;
		}

		.gridItem> :is(p, form) {
			display: inline;
			grid-template-rows: subgrid;
		}

		.gridItem>form>* {
			margin: 2px;
		}

		.userIcon:hover~.profileOverlay,
		.profileOverlay:hover {
			display: flex;
			animation: profileOverlayPop .3s ease-in-out forwards;
		}

		@keyframes profileOverlayPop {
			0% {
				opacity: 0;
			}

			100% {
				opacity: 1;
			}
		}
	</style>

	<script>

		window.isCustomerLoggedIn = null;
		const loadProfileOverlay = async () => {

			const onFailure = (data) => {
				// document.getElementById("registerError").style.display = 'flex';
				// document.getElementById("registerError").textContent = data.message;
			}

			const onSuccess = (data) => {
				return data;
			}

			let response = await requestFetch('/api/isCustomer', 'GET', {}, onFailure, onSuccess);

			if (isCustomerLoggedIn = response.bool)
				document.querySelectorAll('.agencyBtns').forEach(element => element.style.display = 'none');

			displayCars();
		}

		const logout = requestFetch('/api/logout', 'GET', {}, () => { }, () => { });
		// window.location.href = "/assets/logout.php";
		// FIXME: 1. Create logout session php

		const profileOpts = (htmlPage) => window.location.href = `./${htmlPage}`;

		const getCarList = async () => {

			//Filler Database Fetched Data
			// return { "agencyId": { "2": { "carId": { "3": { "model": "Tesla Model S", "license_number": "MH 01 AB 1234", "capacity": "5", "rent_per_day": "600.00" }, "4": { "model": "Porsche Cayenne", "license_number": "DL 02 CD 5678", "capacity": "4", "rent_per_day": "550.00" }, "5": { "model": "Mercedes-Benz GLE", "license_number": "KA 05 EF 9012", "capacity": "5", "rent_per_day": "700.00" }, "6": { "model": "BMW X5", "license_number": "TN 06 GH 3456", "capacity": "4", "rent_per_day": "620.00" }, "7": { "model": "Audi Q7", "license_number": "UP 07 IJ 7890", "capacity": "5", "rent_per_day": "580.00" } } }, "11": { "carId": { "8": { "model": "Land Rover Range Rover", "license_number": "GJ 08 KL 1234", "capacity": "4", "rent_per_day": "800.00" }, "9": { "model": "Bentley Bentayga", "license_number": "MH 09 MN 5678", "capacity": "4", "rent_per_day": "900.00" }, "10": { "model": "Rolls-Royce Cullinan", "license_number": "UP 10 OP 9012", "capacity": "4", "rent_per_day": "850.00" }, "11": { "model": "Ferrari Portofino", "license_number": "DL 11 QR 3456", "capacity": "4", "rent_per_day": "1000.00" }, "12": { "model": "Lamborghini Urus", "license_number": "TN 12 ST 7890", "capacity": "4", "rent_per_day": "950.00" } } }, "13": { "carId": { "13": { "model": "Maserati Levante", "license_number": "KA 13 UV 1234", "capacity": "5", "rent_per_day": "750.00" }, "14": { "model": "Aston Martin DBX", "license_number": "MH 14 WX 5678", "capacity": "4", "rent_per_day": "700.00" }, "15": { "model": "McLaren GT", "license_number": "GJ 15 YZ 9012", "capacity": "5", "rent_per_day": "820.00" }, "16": { "model": "Bugatti Chiron", "license_number": "DL 16 AB 3456", "capacity": "5", "rent_per_day": "1500.00" }, "17": { "model": "Porsche 911 Turbo", "license_number": "TN 17 CD 7890", "capacity": "5", "rent_per_day": "1200.00" } } } } }


			const onFailure = (data) => {
				document.getElementById("registerError").style.display = 'flex';
				document.getElementById("registerError").textContent = data.message;
			}

			const onSuccess = (data) => {
				return data.availableCars;
			}

			return await requestFetch('/api/Cars', 'GET', {}, onFailure, onSuccess);
		}

		const addBooking = (event) => {
			event.preventDefault();

			let formData = new FormData(event.target);

			const onFailure = (data) => {
				alert(data.message);
			}

			const onSuccess = (data) => {
				alert(`Booked car successfully.`);
			}

			requestFetch('/api/Bookings', 'POST', formData, onFailure, onSuccess);
		}

		// Function to display available cars
		async function displayCars() {
			let getList = await getCarList();

			if (!getList)
				return;
			// Loader's default display value is set as 'flex', 
			// however inner html is overwritinng it in this case anyways
			document.getElementById('loader').style.display = 'none';

			var carListDiv = document.getElementById("carList");
			carListDiv.innerHTML = ""; // Clear previous content

			Object.values(getList.agencyId).forEach(function (agency) {
				let car = agency.carId;
				for (let key in car) {

					var carDetails = document.createElement("div");
					carDetails.classList.add("gridItem");

					carDetails.innerHTML = `
						<h3>${car[key].model}</h3>
						<p>License number: ${car[key].licenseNumber}</p>
						<p>Seating capacity: ${car[key].capacity}</p>
						<p>Rent/day: ${car[key].rentPerDay}</p>
					`;

					if (isCustomerLoggedIn) {
						let bookForm = document.createElement("form");
						bookForm.setAttribute('onsubmit', 'addBooking(event)');
						bookForm.setAttribute('class', 'bookForm');
						// Object.assign(bookForm, { action: 'addBooking(event)', class: 'bookForm' });
						bookForm.innerHTML = `
							<input type="number" min="1" max="31" name="daysBooked" title="1 month booking max" required>

							<!--
							<select name="daysBooked" required>
								<option value="1">1 day</option>
								<option value="2">2 days</option>
								<!-- Add more options as needed --><!--
							</select>
							-->

							<input type="date" name="bookDate" required>

							<input type="hidden" name="carId" value = "${key}">
							<input type="submit" value="Rent">
						`;
						carDetails.appendChild(bookForm);
					}

					// var carDetailsWrapper = document.createElement("div");
					// carDetailsWrapper.classList.add("gridItem");
					// carDetailsWrapper.appendChild(carDetails);

					carListDiv.appendChild(carDetails);
				}
			});
		}
	</script>
</body>

</html>