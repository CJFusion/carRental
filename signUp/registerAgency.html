<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Agency Registration</title>
	<link rel="stylesheet" type="text/css" href="../assets/app.css"> <!-- Link to your CSS file -->
</head>

<body class="flexCentered maxViewPort greyBg">

	<div class="container signUpContainer">
		<h2>Agency Registration</h2>
		<div class="hrule vertMargins"></div>
		<form id="agencyRegister" onsubmit="return passMatch(event)">
			<!-- Account Credentials -->
			<input type="hidden" name="userType" value="agency">

			<label for="username">Username:</label>
			<input type="text" id="username" name="username" oninput="validateInput(event, /[^a-zA-Z0-9]/g)" required>

			<label for="email">Agency Email Address:</label>
			<input type="email" id="email" name="email" required>

			<label for="password">Password:</label>
			<input type="password" id="password" name="password" required>

			<label for="confirmPassword">Confirm Password:</label>
			<input type="password" id="confirmPassword" name="confirmPassword" oninput="passMatch(event)" required>
			<span id="passwordError">Passwords
				do not match!</span>

			<h2>Additional Information</h2>
			<div class="hrule vertMargins"></div>

			<!-- Agency Information -->
			<label for="agencyName">Agency Name:</label>
			<input type="text" id="agencyName" name="agencyName" oninput="validateInput(event, /[^a-zA-Z. ]/g)"
				required>

			<label for="fullName">Agency Contact Person Name:</label>
			<input type="text" id="fullName" name="fullName" oninput="validateInput(event, /[^a-zA-Z ]/g)" required>

			<label for="phone">Agency Contact Phone Number:</label>
			<input type="tel" id="phone" name="phone" maxlength="10" title="Enter 10 digit phone number"
				pattern="[0-9]{10,10}" oninput="validateInput(event, /[^0-9]/g)" required>

			<label for="addressState">Agency State/Province:</label>
			<input type="text" id="addressState" name="addressState" oninput="validateInput(event, /[^a-zA-Z]/g)"
				required>

			<div id="registerError"></div>

			<input type="hidden" name="submitAction" value="submitUsers">
			<input type="submit" class="blueBtn" value="Create account">
		</form>
	</div>

	<script>

		const passMatch = (event) => {
			event.preventDefault();
			let property = 'none';
			if (!(document.getElementById("password").value === document.getElementById("confirmPassword").value))
				property = 'flex';
			document.getElementById("passwordError").style.display = property;

			if (!event.submitter)
				return;

			if (property !== 'none') {
				document.getElementById("confirmPassword").focus();
				return;
			}

			createAccAuth(event);
		}

		const createAccAuth = (event) => {
			let formData = new FormData(event.target);

			fetch('../assets/dbHandling.php', {
				method: 'POST',
				body: formData,
				headers: {
					'X-Requested-With': 'fetch'
				}
			}).then(async response => {
				if (response.redirected)
					window.location.href = response.url;

				let res = await response.text();
				try {
					res = JSON.parse(res);
				} catch (error) {
					throw new Error('\nError parsing JSON: ' + res);
				}

				if (!response.ok) {
					if (response.status >= 400) {
						document.getElementById("registerError").style.display = 'flex';
						document.getElementById("registerError").textContent = res.message;
					}
					throw new Error("\n" + res.error + "\n" + res.message);
				}

				return res;
			}).then(data => {
				console.table(data);
				if (data.message === 'New user: "' + formData.get('username') + '" recorded into Users table successfully')
					window.location.href = '../home/rentCar.html';
			}).catch(error => {
				console.error('Fetch API -', error);
			});
		}

		const validateInput = (event, nregex) => event.target.value = event.target.value.replace(nregex, '');

	</script>

	<style>
		#registerError,
		#passwordError {
			display: none;
			color: rgb(217, 48, 37);
			align-self: center;
			font-size: 12px;
			transform: translateY(-10px);
		}

		:is(#registerError, #passwordError)::before {
			content: '!';
			color: white;
			padding: 2px;
			font-family: Carlito;
			font-size: 0.8em;
			margin-right: 5px;
			width: 1.2em;
			height: 1.2em;
			border-radius: 50%;
			background-color: rgb(217, 48, 37);
			text-align: center;
		}
	</style>
</body>

</html>